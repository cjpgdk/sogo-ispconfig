From 97d0d7d145769c9306a2fa06acab516af131cc3b Mon Sep 17 00:00:00 2001
From: "Christian M. Jensen" <christian@cmjscripter.net>
Date: Thu, 23 Jul 2015 03:44:33 +0200
Subject: [PATCH] add user source setting 'ISPConfigUrlPassword' to allow
 password change

---
 SoObjects/SOGo/SQLSource.h |  1 +
 SoObjects/SOGo/SQLSource.m | 23 +++++++++++++++++++++++
 2 files changed, 24 insertions(+)

diff --git a/SoObjects/SOGo/SQLSource.h b/SoObjects/SOGo/SQLSource.h
index 00bf48d..14233bc 100644
--- a/SoObjects/SOGo/SQLSource.h
+++ b/SoObjects/SOGo/SQLSource.h
@@ -46,6 +46,7 @@
   NSString *_sieveHostField;
   NSString *_userPasswordAlgorithm;
   NSURL *_viewURL;
+  NSURL *_ispcPWURL;
   BOOL _prependPasswordScheme;
 
   /* resources handling */
diff --git a/SoObjects/SOGo/SQLSource.m b/SoObjects/SOGo/SQLSource.m
index 7d0de6c..38841d9 100644
--- a/SoObjects/SOGo/SQLSource.m
+++ b/SoObjects/SOGo/SQLSource.m
@@ -97,6 +97,7 @@
       _mailFields = nil;
       _userPasswordAlgorithm = nil;
       _viewURL = nil;
+      _ispcPWURL = nil;
       _kindField = nil;
       _multipleBookingsField = nil;
       _imapHostField = nil;
@@ -114,6 +115,7 @@
   [_mailFields release];
   [_userPasswordAlgorithm release];
   [_viewURL release];
+  [_ispcPWURL release];
   [_kindField release];
   [_multipleBookingsField release];
   [_domainField release];
@@ -150,6 +152,9 @@
   if ([udSource objectForKey: @"viewURL"])
     _viewURL = [[NSURL alloc] initWithString: [udSource objectForKey: @"viewURL"]];
 
+  if ([udSource objectForKey: @"ISPConfigUrlPassword"])
+    _ispcPWURL = [[NSURL alloc] initWithString: [udSource objectForKey: @"ISPConfigUrlPassword"]];
+
 #warning this domain code has no effect yet
   if ([sourceDomain length])
     ASSIGN (_domain, sourceDomain);
@@ -311,9 +316,12 @@
 			   perr: (SOGoPasswordPolicyError *) perr
 {
   EOAdaptorChannel *channel;
+  EOAdaptorChannel *channelispc;
   GCSChannelManager *cm;
   NSException *ex;
+  NSException *exispc;
   NSString *sqlstr;
+  NSString *sqlstrispc;
   BOOL didChange;
   BOOL isOldPwdOk;
 
@@ -345,6 +353,21 @@
 	  if (!ex)
 	    {
 	      didChange = YES;
+
+	      channelispc = [cm acquireOpenChannelForURL: _ispcPWURL];
+	      if(channelispc)
+	      {
+	          sqlstrispc = [NSString stringWithFormat: (@"UPDATE %@"
+                          @" SET password = '%@'"
+                          @" WHERE login = '%@'"),
+                          [_ispcPWURL gcsTableName], encryptedPassword, login];
+	          exispc = [channelispc evaluateExpressionX: sqlstrispc];
+	          if (exispc)
+	          {
+	              [self errorWithFormat: @"could not run SQL '%@': %@", sqlstrispc, exispc];
+	          }
+	          [cm releaseChannel: channelispc];
+	      }
 	    }
 	  else
 	    {
-- 
1.9.5.msysgit.0

